{% extends 'base.html' %}

{% block title %}Report - NV Poultry Farm{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0" style="color: #2c5282; font-weight: 700;">
            <i class="fas fa-chart-bar me-2"></i>Data Reports
        </h2>
        <div class="d-flex align-items-center gap-3">
            <div class="date-range">
                <div class="d-flex gap-2 align-items-center">
                    <div>
                        <label class="form-label small">From</label>
                        <input type="date" id="start-date" class="form-control form-control-sm">
                    </div>
                    <div>
                        <label class="form-label small">To</label>
                        <input type="date" id="end-date" class="form-control form-control-sm">
                    </div>
                    <button onclick="fetchReportData()" class="btn btn-primary btn-sm mt-4">
                        <i class="fas fa-sync-alt me-1"></i> Update
                    </button>
                    <button onclick="downloadExcel()" class="btn btn-success btn-sm ms-2 mt-4">
                        <i class="fas fa-file-excel me-1"></i> Download Excel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- SIAF Data Tab -->
    <ul class="nav nav-tabs mb-4" id="reportTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="siaf-tab" data-bs-toggle="tab" data-bs-target="#siaf" type="button" role="tab">
                <i class="fas fa-feather-alt me-1"></i>SIAF
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="reportTabContent">
        <!-- SIAF Tab -->
        <div class="tab-pane fade show active" id="siaf" role="tabpanel">
            <div class="table-responsive">
                <table class="table table-hover" id="siaf-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Total Feed (kg)</th>
                            <th>Tray Eggs</th>
                            <th>Total Eggs</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <span id="modal-breed-type"></span> Record Details - 
                    <span id="modal-date"></span>
                </h5>
                <div>
                    <button type="button" class="btn btn-primary btn-sm me-2" onclick="printModalContent()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body">
                <!-- Daily Totals -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Daily Totals</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Total Tray Eggs:</strong> <span id="modal-tray-egg-total"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p class="highlight-total"><strong>Total Eggs:</strong> <span id="modal-total-egg-total"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Total Damaged:</strong> <span id="modal-damaged-egg-total"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Total Double:</strong> <span id="modal-double-egg-total"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Egg Collection - Morning -->
                <div class="detail-section mb-4" style="display:none;">
                    <h6 class="section-title">Morning Egg Collection</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Tray Eggs:</strong> <span id="modal-tray-egg-morning"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Total Eggs:</strong> <span id="modal-total-egg-morning"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Damaged Eggs:</strong> <span id="modal-damaged-egg-morning"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Double Eggs:</strong> <span id="modal-double-egg-morning"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Egg Collection - Evening -->
                <div class="detail-section mb-4" style="display:none;">
                    <h6 class="section-title">Evening Egg Collection</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Tray Eggs:</strong> <span id="modal-tray-egg-evening"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Total Eggs:</strong> <span id="modal-total-egg-evening"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Damaged Eggs:</strong> <span id="modal-damaged-egg-evening"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Double Eggs:</strong> <span id="modal-double-egg-evening"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Feed Information -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Feed Information</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <p><strong>Morning Feed:</strong> <span id="modal-feed-morning"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Evening Feed:</strong> <span id="modal-feed-evening"></span></p>
                        </div>
                        <div class="col-md-4">
                            <p><strong>Water Intake:</strong> <span id="modal-water-intake"></span></p>
                        </div>
                    </div>
                    <div class="row mt-3 total-section">
                        <div class="col-md-12">
                            <p class="mb-0"><strong>Total Feed:</strong> <span id="modal-feed-total"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Feed Per Bird & Daily Closing Stock -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Feed Per Bird & Daily Closing Stock</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p class="highlight-total"><strong>Feed Per Bird Today:</strong> <span id="modal-feed-per-bird"></span> g</p>
                        </div>
                        <div class="col-md-3">
                            <p class="highlight-total"><strong>Daily Closing Stock:</strong> <span id="modal-daily-closing-stock"></span> kg</p>
                        </div>
                        <div class="col-md-3">
                            <p class="highlight-total"><strong>Bundles:</strong> <span id="modal-daily-closing-bundles"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Temperature Reading -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Temperature Readings</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Temp 1 (6:00 AM):</strong> <span id="modal-temperature-1"></span>°C</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Temp 2 (10:00 AM):</strong> <span id="modal-temperature-2"></span>°C</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Temp 3 (2:00 PM):</strong> <span id="modal-temperature-3"></span>°C</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Temp 4 (6:00 PM):</strong> <span id="modal-temperature-4"></span>°C</p>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <p><strong>Temp 5 (10:00 PM):</strong> <span id="modal-temperature-5"></span>°C</p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Temp 6 (2:00 AM):</strong> <span id="modal-temperature-6"></span>°C</p>
                        </div>
                    </div>
                </div>

                <!-- Mortality Count -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Mortality Count</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>Male Mortality:</strong> <span id="modal-male-mortality"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Female Mortality:</strong> <span id="modal-female-mortality"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p class="highlight-total"><strong>Total Mortality:</strong> <span id="modal-total-mortality-count"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Equipment Status -->
                <div class="detail-section mb-4">
                    <h6 class="section-title">Equipment Status</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <p><strong>AI Status:</strong> <span id="modal-ai-status"></span></p>
                            <p><strong>AI Hours:</strong> <span id="modal-ai-hours"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Fogger Status:</strong> <span id="modal-fogger-status"></span></p>
                            <p><strong>Fogger Hours:</strong> <span id="modal-fogger-hours"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Fan Status:</strong> <span id="modal-fan-status"></span></p>
                            <p><strong>Fan Hours:</strong> <span id="modal-fan-hours"></span></p>
                        </div>
                        <div class="col-md-3">
                            <p><strong>Light Status:</strong> <span id="modal-light-status"></span></p>
                            <p><strong>Light Hours:</strong> <span id="modal-light-hours"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Other Information -->
                <div class="detail-section">
                    <h6 class="section-title">Other Information</h6>
                    <div class="row">
                        <div class="col-md-12">
                            <p><strong>Medicine:</strong> <span id="modal-medicine"></span></p>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <p><strong>Notes:</strong></p>
                            <p id="modal-notes" class="notes-text"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .table thead th {
        background: #f8fafc;
        border-bottom: 2px solid #e2e8f0;
        color: #2d3748;
        font-weight: 600;
        padding: 12px;
    }
    
    .table tbody td {
        padding: 12px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .nav-tabs .nav-link {
        color: #4a5568;
        font-weight: 500;
        padding: 0.75rem 1.25rem;
        border: none;
        border-bottom: 2px solid transparent;
    }
    
    .nav-tabs .nav-link.active {
        color: #2c5282;
        border-bottom: 2px solid #2c5282;
        font-weight: 600;
    }
    
    .date-range .form-control {
        border-radius: 6px;
        border: 1px solid #e2e8f0;
    }
    
    .btn-primary {
        background-color: #2c5282;
        border-color: #2c5282;
    }
    
    .btn-primary:hover {
        background-color: #2b6cb0;
        border-color: #2b6cb0;
    }

    /* Modal Styles */
    .modal-content {
        border-radius: 12px;
        border: none;
    }

    .modal-header {
        background-color: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        border-radius: 12px 12px 0 0;
    }

    .detail-section {
        padding: 15px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .section-title {
        color: #2c5282;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid #e2e8f0;
    }

    .notes-text {
        padding: 10px;
        background-color: #f8fafc;
        border-radius: 6px;
        min-height: 60px;
    }

    .total-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 2px dashed #e2e8f0;
        background-color: #f8fafc;
        border-radius: 6px;
        padding: 10px;
    }

    .total-section strong {
        color: #2c5282;
    }

    .highlight-total {
        background-color: #ebf8ff;
        padding: 6px 12px;
        border-radius: 4px;
        border: 2px solid #2c5282;
        font-weight: bold;
        color: #2c5282;
        display: inline-block;
        width: auto;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }

    .highlight-total strong {
        color: #2c5282;
        font-weight: 700;
        display: inline-block;
    }

    .highlight-total span {
        color: #2c5282;
        font-size: 1.1em;
        font-weight: 700;
        display: inline-block;
        background: #ebf8ff;
        padding: 0 4px;
    }

    .view-btn {
        padding: 4px 8px;
        font-size: 0.85rem;
    }

    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .container {
            padding-left: 10px;
            padding-right: 10px;
        }

        .table th, .table td {
            padding: 8px;
        }

        .date-range {
            flex-direction: column;
            width: 100%;
        }

        .date-range .d-flex {
            flex-direction: column;
            width: 100%;
        }

        .date-range div {
            width: 100%;
            margin-bottom: 10px;
        }

        .date-range button {
            width: 100%;
            margin-top: 10px !important;
        }

        .modal-dialog {
            margin: 10px;
        }
    }

    /* Print Styles */
    @media print {
        body * {
            visibility: hidden;
        }
        
        .modal-content {
            visibility: visible;
            position: absolute;
            left: 0;
            top: 0;
            width: 210mm;  /* A4 width */
            height: 297mm;  /* A4 height */
            margin: 0;
            padding: 10mm 10mm;  /* Further reduced margin */
            box-shadow: none;
            font-size: 9pt;  /* Even smaller base font size */
        }

        .modal-content * {
            visibility: visible;
        }

        .modal-header {
            border-bottom: 1px solid #000;
            padding-bottom: 3mm;  /* Further reduced padding */
            margin-bottom: 3mm;
        }

        .modal-header h5 {
            font-size: 12pt;
            margin: 0;
        }

        .btn-close, .btn {
            display: none;
        }

        .detail-section {
            break-inside: avoid;
            margin-bottom: 2mm;  /* Further reduced margin */
            padding: 2mm;  /* Further reduced padding */
            border: none;
            box-shadow: none;
            page-break-inside: avoid;
        }

        .section-title {
            font-size: 10pt;  /* Smaller title */
            margin-bottom: 2mm;
            padding-bottom: 1mm;
            border-bottom: 1px solid #000;
        }

        .row {
            display: flex;
            margin-bottom: 1mm;  /* Further reduced margin */
            gap: 1mm;  /* Smaller gap */
            flex-wrap: nowrap;  /* Prevent wrapping */
            width: 100%;
        }

        .row p {
            margin: 0;  /* Remove paragraph margins */
            line-height: 1.2;  /* Reduced line height */
            white-space: nowrap;  /* Prevent text wrapping */
        }

        .col-md-3, .col-md-4, .col-md-8, .col-12 {
            flex: 0 0 auto;
            padding: 0 1mm;  /* Further reduced padding */
            min-width: 0;  /* Allow columns to shrink */
        }

        /* Ensure columns maintain their width ratios */
        @media print {
            .col-md-3 { 
                width: 25%; 
                flex: 0 0 25%;
            }
            .col-md-4 { 
                width: 33.33%; 
                flex: 0 0 33.33%;
            }
            .col-md-8 { 
                width: 66.67%;
                flex: 0 0 66.67%; 
            }
            .col-md-12 { 
                width: 100%;
                flex: 0 0 100%; 
            }
            
            /* Make text slightly smaller for these specific items to prevent wrapping */
            #modal-double-egg-morning,
            #modal-double-egg-evening,
            #modal-water-intake {
                font-size: 8pt;
            }
            
            /* Reduce space between label and value */
            .row p strong {
                margin-right: 1mm;
            }

            /* Print styles for highlighted total */
            .modal-content .detail-section .row .highlight-total {
                background-color: #e2e8f0 !important;
                border: 2px solid #000 !important;
                padding: 2mm 3mm !important;
                border-radius: 2px !important;
                margin: -2mm 0 !important;
                box-shadow: 0 0 0 1px #000 !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .modal-content .detail-section .row .highlight-total strong {
                color: #000 !important;
                font-weight: 700 !important;
                font-size: 11pt !important;
            }

            .modal-content .detail-section .row .highlight-total span {
                color: #000 !important;
                font-weight: 700 !important;
                font-size: 11pt !important;
                background: #e2e8f0 !important;
                padding: 0 2mm !important;
            }

            /* Ensure background prints in different browsers */
            @-moz-document url-prefix() {
                .highlight-total {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }
            }
        }

        .col-md-3 { width: 25%; }
        .col-md-4 { width: 33.33%; }
        .col-md-8 { width: 66.67%; }
        .col-12 { width: 100%; }

        .notes-text {
            border: 1px solid #ccc;
            padding: 1mm;
            margin-top: 1mm;
            font-size: 8pt;  /* Even smaller font for notes */
            max-height: 25mm;  /* Reduced height for notes */
            overflow: hidden;
        }

        .total-section {
            margin-top: 2mm;
            padding: 2mm;
            border-top: 1px dashed #000;
            background-color: #f8fafc;
        }

        .print-header h1 {
            font-size: 16pt;
            margin: 0 0 5mm 0;
        }

        /* Ensure content fits on one page */
        @page {
            size: A4;
            margin: 0;
        }

        /* Hide empty sections */
        .detail-section:empty {
            display: none;
        }

        /* Compact spacing for equipment status */
        .detail-section .row .col-md-4 p {
            margin-bottom: 1mm;
        }
    }
</style>

<script>
    // Function to handle printing
    function printModalContent() {
        // Add a title for the printed page
        const printHeader = document.createElement('div');
        printHeader.className = 'print-header';
        printHeader.innerHTML = `
            <h1 style="text-align: center; margin-bottom: 20px;">NV Poultry Farm Report</h1>
        `;
        
        const modalContent = document.querySelector('.modal-content');
        modalContent.insertBefore(printHeader, modalContent.firstChild);
        
        // Print the document
        window.print();
        
        // Remove the print header after printing
        printHeader.remove();
    }

    // Reset date range when page loads
    document.addEventListener('DOMContentLoaded', function() {
        resetDateRange();
        fetchReportData();
    });

    function resetDateRange() {
        const today = new Date();
        const sevenDaysAgo = new Date(today);
        sevenDaysAgo.setDate(today.getDate() - 7);
        
        document.getElementById('start-date').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('end-date').value = today.toISOString().split('T')[0];
    }

    // Add event listener for page refresh
    window.addEventListener('beforeunload', function() {
        sessionStorage.removeItem('reportDateRange');
    });

    function fetchReportData() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        // Fetch data for SIAF
        fetch(`/report-data/?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateTable('siaf-table', data.records, 'siaf');
            }
        })
        .catch(error => console.error('Error fetching data:', error));
    }

    function populateTable(tableId, records) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = '';

        records.forEach(record => {
            const totalFeed = (parseFloat(record.feed_morning || 0) + parseFloat(record.feed_evening || 0)).toFixed(2);
            const totalTrayEggs = parseInt(record.tray_egg_morning || 0) + parseInt(record.tray_egg_evening || 0);
            const totalEggs = parseInt(record.total_egg_morning || 0) + parseInt(record.total_egg_evening || 0);
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${formatDate(record.date)}</td>
                <td>${totalFeed}</td>
                <td>${totalTrayEggs}</td>
                <td>${totalEggs}</td>
                <td>
                    <button class="btn btn-primary btn-sm view-btn" onclick="viewDetails('${record.date}')">
                        <i class="fas fa-eye me-1"></i>View
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function viewDetails(date) {
        // Fetch detailed record for SIAF
        fetch(`/fetch-record-SIAF/?date=${date}`)
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const data = result.data;
                    
                    // Update modal title
                    document.getElementById('modal-breed-type').textContent = 'SIAF';
                    document.getElementById('modal-date').textContent = formatDate(date);

                    // Feed Information
                    const feedMorning = parseFloat(data.feed_morning || 0);
                    const feedEvening = parseFloat(data.feed_evening || 0);
                    document.getElementById('modal-feed-morning').textContent = feedMorning;
                    document.getElementById('modal-feed-evening').textContent = feedEvening;
                    document.getElementById('modal-water-intake').textContent = data.water_intake || '0';
                    document.getElementById('modal-feed-total').textContent = (feedMorning + feedEvening).toFixed(2);

                    // Morning Egg Collection
                    const trayMorning = parseInt(data.tray_egg_morning || 0);
                    const totalMorning = parseInt(data.total_egg_morning || 0);
                    const damagedMorning = parseInt(data.damaged_egg_morning || 0);
                    const doubleMorning = parseInt(data.double_egg_morning || 0);
                    document.getElementById('modal-tray-egg-morning').textContent = trayMorning;
                    document.getElementById('modal-total-egg-morning').textContent = totalMorning;
                    document.getElementById('modal-damaged-egg-morning').textContent = damagedMorning;
                    document.getElementById('modal-double-egg-morning').textContent = doubleMorning;

                    // Evening Egg Collection
                    const trayEvening = parseInt(data.tray_egg_evening || 0);
                    const totalEvening = parseInt(data.total_egg_evening || 0);
                    const damagedEvening = parseInt(data.damaged_egg_evening || 0);
                    const doubleEvening = parseInt(data.double_egg_evening || 0);
                    document.getElementById('modal-tray-egg-evening').textContent = trayEvening;
                    document.getElementById('modal-total-egg-evening').textContent = totalEvening;
                    document.getElementById('modal-damaged-egg-evening').textContent = damagedEvening;
                    document.getElementById('modal-double-egg-evening').textContent = doubleEvening;

                    // Update Daily Totals
                    document.getElementById('modal-tray-egg-total').textContent = trayMorning + trayEvening;
                    document.getElementById('modal-total-egg-total').textContent = totalMorning + totalEvening;
                    document.getElementById('modal-damaged-egg-total').textContent = damagedMorning + damagedEvening;
                    document.getElementById('modal-double-egg-total').textContent = doubleMorning + doubleEvening;

                    // Feed Per Bird and Daily Closing Stock
                    document.getElementById('modal-feed-per-bird').textContent = data.feed_per_gram_per_bird || '0';
                    document.getElementById('modal-daily-closing-stock').textContent = data.daily_closing_stock || '0';
                    document.getElementById('modal-daily-closing-bundles').textContent = data.daily_closing_bundles || '0';

                    // Temperature Readings
                    document.getElementById('modal-temperature-1').textContent = data.temperature_1 || '0';
                    document.getElementById('modal-temperature-2').textContent = data.temperature_2 || '0';
                    document.getElementById('modal-temperature-3').textContent = data.temperature_3 || '0';
                    document.getElementById('modal-temperature-4').textContent = data.temperature_4 || '0';
                    document.getElementById('modal-temperature-5').textContent = data.temperature_5 || '0';
                    document.getElementById('modal-temperature-6').textContent = data.temperature_6 || '0';

                    // Mortality Count
                    document.getElementById('modal-male-mortality').textContent = data.male_mortality || '0';
                    document.getElementById('modal-female-mortality').textContent = data.female_mortality || '0';
                    document.getElementById('modal-total-mortality-count').textContent = data.total_mortality || '0';

                    // Equipment Status
                    document.getElementById('modal-ai-status').textContent = data.artificial_insemination || 'No';
                    document.getElementById('modal-ai-hours').textContent = data.ai_hours || '0';
                    document.getElementById('modal-fogger-status').textContent = data.fogger_used || 'No';
                    document.getElementById('modal-fogger-hours').textContent = data.fogger_hours || '0';
                    document.getElementById('modal-fan-status').textContent = data.fan_used || 'No';
                    document.getElementById('modal-fan-hours').textContent = data.fan_hours || '0';
                    document.getElementById('modal-light-status').textContent = data.light_used || 'No';
                    document.getElementById('modal-light-hours').textContent = data.light_hours || '0';

                    // Other Information
                    document.getElementById('modal-medicine').textContent = data.medicine || 'None';
                    document.getElementById('modal-notes').textContent = data.notes || 'No notes';

                    // Show the modal
                    new bootstrap.Modal(document.getElementById('detailModal')).show();
                }
            })
            .catch(error => console.error('Error fetching record details:', error));
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function downloadExcel() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        
        if (!startDate || !endDate) {
            alert('Please select a date range first');
            return;
        }

        // Create the download URL with parameters
        const url = `/download-excel/?start_date=${startDate}&end_date=${endDate}`;
        
        // Create a temporary link and click it to start the download
        const link = document.createElement('a');
        link.href = url;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
{% endblock %}
